# ============================================================
# CI/CD Pipeline — ACCA LMS Backend → AWS Lightsail
# ============================================================
# Triggers on push to main when backend/ files change.
#
# Jobs:
#   1. ci     — lint, typecheck, build (validates code quality)
#   2. deploy — SSH into Lightsail and run deploy script
#
# Required GitHub Secrets:
#   LIGHTSAIL_HOST        — Public API hostname (optional for SSH; can be proxied)
#   LIGHTSAIL_SSH_HOST    — Lightsail static IP or DNS-only hostname for SSH (recommended)
#   LIGHTSAIL_USER        — SSH user (usually "ubuntu")
#   LIGHTSAIL_SSH_KEY     — Private SSH key (PEM/OpenSSH) for the server
# ============================================================

name: Backend CI/CD

on:
  push:
    branches: [main]
    paths:
      - "backend/**"
      - ".github/workflows/deploy-backend.yml"
  pull_request:
    branches: [main]
    paths:
      - "backend/**"

concurrency:
  group: backend-deploy-${{ github.ref }}
  cancel-in-progress: true

# ─── CI Job ──────────────────────────────────────────────────
jobs:
  ci:
    name: Lint, Typecheck & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Typecheck
        run: npm run typecheck

      - name: Build
        run: npm run build

  # ─── Deploy Job ────────────────────────────────────────────
  deploy:
    name: Deploy to Lightsail
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Preflight - check SSH port
        run: |
          nc -vz -w 10 ${{ secrets.LIGHTSAIL_SSH_HOST || secrets.LIGHTSAIL_HOST }} 22

      - name: Prepare SSH key file
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "${{ secrets.LIGHTSAIL_SSH_KEY }}" > ~/.ssh/lightsail_key
          chmod 600 ~/.ssh/lightsail_key

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.LIGHTSAIL_SSH_HOST || secrets.LIGHTSAIL_HOST }}
          port: 22
          username: ${{ secrets.LIGHTSAIL_USER }}
          key_path: ~/.ssh/lightsail_key
          timeout: 60s
          command_timeout: 20m
          script: |
            set -e
            echo "=========================================="
            echo " Deploying ACCA LMS Backend (Production)"
            echo " Triggered by: ${{ github.actor }}"
            echo " Commit: ${{ github.sha }}"
            echo "=========================================="

            DEPLOY_DIR=~/apps/learnspire/prod/learnspire-project

            # Pull latest code
            cd "$DEPLOY_DIR"
            git fetch origin main
            git reset --hard origin/main

            # Install deps & build
            cd backend
            npm install --prefer-offline --no-audit

            npm run build

            # Install production deps in build/
            cd build
            npm install --production --prefer-offline --no-audit

            # Run migrations (safe — only applies pending)
            cd ..
            node ace migration:run --force

            # Restart PM2 app
            pm2 restart learnspire-prod --update-env

            # Wait for app to come up
            sleep 3

            # Health check
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3333/health || true)
            if [ "$STATUS" = "200" ]; then
              echo "✅ Health check passed (HTTP $STATUS)"
            else
              echo "⚠️  Health check returned HTTP $STATUS"
              pm2 logs learnspire-prod --lines 20 --nostream
              exit 1
            fi

            echo "=========================================="
            echo " Deployment complete!"
            echo "==========================================" 
